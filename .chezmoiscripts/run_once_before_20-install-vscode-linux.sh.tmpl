{{ if (eq .chezmoi.os "linux") -}}
#!/bin/bash

set -euo pipefail

# Default extensions to install
# Use code --list-extensions to see all installed extensions
extensions=(
    EditorConfig.EditorConfig
    esbenp.prettier-vscode
    mikestead.dotenv
    PKief.material-icon-theme
    streetsidesoftware.code-spell-checker
    tinkertrain.theme-panda
    yzhang.markdown-all-in-one
)

{{   if (eq .chezmoi.osRelease.id "fedora") -}}
# Import keys
sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc

# Add repository
sudo sh -c 'echo -e "[code]\nname=Visual Studio Code\nbaseurl=https://packages.microsoft.com/yumrepos/vscode\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.microsoft.com/keys/microsoft.asc" > /etc/yum.repos.d/vscode.repo'

# Install VS Code package
sudo dnf update
sudo dnf install -y code

{{   else if (eq (get .chezmoi.osRelease "idLike") "debian" "ubuntu") -}}
tempdir=$(mktemp -d)
cleanup() {
    popd > /dev/null
    rm -rf ${tempdir}
}
trap cleanup EXIT

pushd ${tempdir} > /dev/null

# Install prerequisite packages
sudo apt-get install --yes \
	apt-transport-https \
	software-properties-common \
    wget

# Add keys
wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
sudo install -o root -g root -m 644 packages.microsoft.gpg /etc/apt/trusted.gpg.d/

# Add sources
sudo sh -c 'echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/trusted.gpg.d/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list'

# Install VS Code package
sudo apt update
sudo apt install --yes code
{{   end -}}

# Install default extensions
for extension in ${extensions[@]}; do
	code --force --install-extension $extension
done

{{ end -}}
